<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Waddle Box on Tiny Planet</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Courier New', monospace; user-select: none; }
        
        /* HUD */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        #top-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 3px 3px 0 #000;
        }

        .hud-item { background: rgba(0,0,0,0.4); padding: 8px 15px; border-radius: 8px; border: 2px solid #000; }

        /* POWER UP UI */
        #power-ui {
            align-self: center;
            text-align: center;
            display: none;
            margin-bottom: 40px;
        }

        #power-text {
            color: #00FFFF; font-size: 32px; font-weight: bold; text-shadow: 0 0 10px #00FFFF; 
            margin-bottom: 10px; text-transform: uppercase; animation: pulse 0.2s infinite alternate;
        }

        #power-bar-bg {
            width: 300px; height: 20px; background: rgba(0,0,0,0.5);
            border: 3px solid white; border-radius: 10px; overflow: hidden; box-shadow: 4px 4px 0px black;
        }

        #power-bar-fill { width: 100%; height: 100%; background: #00FFFF; transform-origin: left; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* OVERLAYS & MODALS */
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border: 4px solid black; box-shadow: 10px 10px 0px black;
            padding: 30px; text-align: center; pointer-events: auto; min-width: 320px;
            display: none; z-index: 100;
        }

        #transition-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; color: white; pointer-events: none;
            backdrop-filter: blur(4px); z-index: 90;
        }
        
        #trans-title { font-size: 50px; color: #FFD700; text-shadow: 4px 4px 0 #000; margin-bottom: 20px; font-weight: bold;}
        #trans-msg { font-size: 22px; max-width: 600px; text-align: center; margin-bottom: 30px; line-height: 1.6; background: #000; padding: 20px; border: 2px solid white; border-radius: 10px;}
        #countdown { font-size: 100px; font-weight: bold; text-shadow: 5px 5px 0 #000; color: #FFD700; }

        .blink { animation: blinker 1s linear infinite; color: #d32f2f; font-weight: bold; margin-top: 20px; font-size: 18px; }
        @keyframes blinker { 50% { opacity: 0; } }

        h1 { margin: 0 0 10px 0; text-transform: uppercase; font-size: 32px; }
        .win { color: #4CAF50; }
        .lose { color: #F44336; }
        
        #music-note { position: absolute; bottom: 20px; right: 20px; color: white; opacity: 0.5; font-size: 12px; pointer-events: auto; cursor: pointer; }

        /* LEADERBOARD STYLES */
        .lb-container { margin-top: 20px; max-height: 250px; overflow-y: auto; text-align: left; border: 2px solid #ddd; padding: 10px; font-size: 14px; min-width: 280px; }
        .lb-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; }
        .lb-name { font-weight: bold; }
        
        #input-row { display: flex; margin-top: 15px; justify-content: center; gap: 10px; }
        input { font-family: inherit; padding: 8px; border: 2px solid black; font-weight: bold; text-transform: uppercase; width: 150px;}
        button.small-btn { background: #FFD700; border: 2px solid black; font-family: inherit; font-weight: bold; cursor: pointer; padding: 8px 15px; box-shadow: 2px 2px 0px black; }
        button.small-btn:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0px black; }

    </style>
    
    <!-- GOOGLE ANALYTICS (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R8CDWJX8K3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-R8CDWJX8K3');
    </script>
</head>
<body>

<!-- HUD -->
<div id="ui-layer">
    <div id="top-bar">
        <div class="hud-item">TOTAL SCORE: <span id="score-total">0</span></div>
        <div class="hud-item">LEVEL: <span id="level-num">1</span></div>
        <div class="hud-item" style="color:#FFD700">COINS: <span id="score-level">0</span> / 20</div>
    </div>
    <div id="power-ui">
        <div id="power-text">POWER UP!</div>
        <div id="power-bar-bg"><div id="power-bar-fill"></div></div>
    </div>
    <div id="music-note" onclick="toggleMute()">Music: ON</div>
</div>

<!-- TRANSITION -->
<div id="transition-screen">
    <div id="trans-title">GET READY</div>
    <div id="trans-msg">
        1. Collect 20 Gold Coins.<br>
        2. Avoid the Red Slimes.<br>
        3. Eat Blue Pills to chase them back!
    </div>
    <div id="countdown">3</div>
</div>

<!-- START SCREEN -->
<div id="start-screen" class="overlay" style="display:block;">
    <h1>Waddle Box<br><small style="font-size:16px">on Tiny Planet</small></h1>
    <p>Arcade Edition</p>
    <div class="blink">PRESS SPACE TO START</div>
    <button class="small-btn" onclick="Leaderboard.show(false)">VIEW LEADERBOARD</button>
    <small style="display:block; margin-top:15px; color:#666;">(Ensure 'music.mp3' is in folder)</small>
</div>

<!-- HIGH SCORE OVERLAY (For viewing from Menu) -->
<div id="highscore-overlay" class="overlay">
    <h3>TOP PLAYERS</h3>
    <div id="hs-list" class="lb-container">Loading...</div>
    <button class="small-btn" style="margin-top:15px" onclick="document.getElementById('highscore-overlay').style.display='none'">CLOSE</button>
</div>

<!-- GAME OVER / SUBMIT SCORE -->
<div id="game-over" class="overlay">
    <h1 id="go-title">Game Over</h1>
    <p id="go-msg">Result</p>
    
    <!-- Score Submission Form -->
    <div id="submit-form">
        <p style="margin-bottom:5px; font-size:14px;">Submit your score to the world!</p>
        <div id="input-row">
            <input type="text" id="player-name" placeholder="YOUR NAME" maxlength="10">
            <button class="small-btn" onclick="submitScore()">SUBMIT</button>
        </div>
    </div>
    
    <div id="leaderboard-display" style="display:none;">
        <h3>TOP PLAYERS</h3>
        <div id="leaderboard-ui" class="lb-container">Loading...</div>
    </div>

    <div class="blink" style="margin-top:30px">PRESS SPACE TO RESTART</div>
</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
    }
  }
</script>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from 'firebase/app';
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from 'firebase/firestore';

    const firebaseConfig = {
        apiKey: "AIzaSyB0pnhWTX7edqLipE1OQZUaqaallOEPMdw",
        authDomain: "waddle-box.firebaseapp.com",
        projectId: "waddle-box",
        storageBucket: "waddle-box.firebasestorage.app",
        messagingSenderId: "451829228466",
        appId: "1:451829228466:web:40da2b729aa61d9d667aab",
        measurementId: "G-R8CDWJX8K3"
    };

    let db = null;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Firebase Initialized Successfully");
    } catch(e) {
        console.warn("Firebase init failed:", e);
    }

    // --- LEADERBOARD LOGIC EXPORTED TO WINDOW ---
    window.submitScore = async function() {
        if(!db) { alert("Database connection failed."); return; }
        
        const rawName = document.getElementById('player-name').value;
        // Sanitize (Security)
        const name = rawName.replace(/[^a-zA-Z0-9 ]/g, '').toUpperCase().trim().substring(0, 10) || "ANON";
        const score = window.finalTotalScore || 0;
        
        const btn = document.querySelector('#submit-form button');
        btn.disabled = true;
        btn.innerText = "...";

        try {
            await addDoc(collection(db, "leaderboard"), {
                name: name,
                score: score,
                timestamp: Date.now()
            });
            
            document.getElementById('submit-form').style.display = 'none';
            window.Leaderboard.show(true); // Show in Game Over
            
            if(typeof gtag === 'function') gtag('event', 'score_submit', { score: score, level: window.currentLevel });
        } catch (e) {
            console.error("Error adding score: ", e);
            alert("Could not save score. Check Firestore.");
            btn.disabled = false;
            btn.innerText = "SUBMIT";
        }
    };

    window.Leaderboard = {
        show: async function(inGameOver = false) {
            if(!db) { alert("Leaderboard database not connected."); return; }

            // Decide which container to use
            const containerId = inGameOver ? 'leaderboard-ui' : 'hs-list';
            const wrapperId = inGameOver ? 'leaderboard-display' : 'highscore-overlay';
            
            // Show the wrapper
            document.getElementById(wrapperId).style.display = 'block';
            
            const ui = document.getElementById(containerId);
            ui.innerHTML = "Loading...";

            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                let html = "";
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Sanitized display (Security)
                    const safeName = data.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    html += `<div class="lb-row"><span class="lb-name">${safeName}</span><span>${data.score}</span></div>`;
                });
                ui.innerHTML = html || "No scores yet. Be the first!";
            } catch(e) {
                ui.innerHTML = "Error loading scores.";
                console.error(e);
            }
        }
    }
</script>

<script>
    // --- BGM CONTROLLER ---
    const BGM = new Audio('music.mp3');
    BGM.loop = true;
    BGM.volume = 0.4; 
    let isMuted = false;
    function toggleMute() {
        isMuted = !isMuted;
        BGM.muted = isMuted;
        document.getElementById('music-note').innerText = "Music: " + (isMuted ? "OFF" : "ON");
    }
</script>

<script type="module">
    import * as THREE from 'three';

    function trackEvent(eventName, params = {}) {
        if(typeof gtag === 'function') {
            gtag('event', eventName, params);
        }
    }

    // --- AUDIO SFX ---
    const AudioCtx = {
        ctx: null,
        init: function() {
            if (this.ctx) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        },
        playTone: function(freq, type, duration, vol=0.1) {
            if(!this.ctx) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },
        jump: function() { this.playTone(150, 'triangle', 0.1, 0.1); },
        coin: function() { this.playTone(1200, 'sine', 0.1, 0.05); },
        powerUp: function() {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, this.ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.4);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.4);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.4);
        },
        levelUp: function() {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, this.ctx.currentTime);
            osc.frequency.setValueAtTime(600, this.ctx.currentTime + 0.1);
            osc.frequency.setValueAtTime(800, this.ctx.currentTime + 0.2);
            gain.gain.value = 0.1;
            gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.6);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.6);
        },
        eatGhost: function() {
            this.playTone(100, 'sawtooth', 0.1, 0.1); 
            setTimeout(() => this.playTone(150, 'sawtooth', 0.1, 0.1), 50);
        },
        die: function() {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.5);
            gain.gain.value = 0.2;
            gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.5);
        }
    };

    // --- CONFIG ---
    const CFG = {
        colors: {
            bg: 0x1a1a2e, planet: 0x7Ec850, player: 0xFFD700, enemyNormal: 0xFF4444, enemyVuln: 0x4444FF,
            coin: 0xFFD700, powerPill: 0x00FFFF, tree: 0x2E7D32, trunk: 0x5D4037, rock: 0x757575, outline: 0x000000
        },
        planetRadius: 30, moveSpeed: 0.28, turnSpeed: 0.06, jumpForce: 0.65, gravity: 0.035,
        baseEnemySpeed: 0.13, totalCoins: 20, powerDuration: 6000, outlineThickness: 0.025,
        camHeight: 25, camDistance: 35, camLag: 0.08
    };

    // --- STATE ---
    let gameState = "WAITING"; 
    let currentLevel = 1;
    let levelScore = 0;
    let totalScore = 0;
    let powerUpEndTime